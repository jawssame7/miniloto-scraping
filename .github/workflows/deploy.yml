name: only master branch

on:
  push:
    branches:
      - master
jobs:
  deploy:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          ref: master
      - name: ssh key generate
        run: echo "$SSH_SECRET_KEY" > key && chmod 600 key
        env:
          SSH_SECRET_KEY: ${{ secrets.SSH_SECRET_KEY }}
      - name: composer install
      - name: add permission
        run: chmod -R g+w app && sudo groupadd -f apache && sudo chown -R :apache app
      - name: ssh key generate
        run: echo ”$SSH_PRIVATE_KEY” ＞ key && chmod 600 key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: rsync deploy
        # rsync -avzre "ssh -i /Users/sameshima/.ssh/sakura-vps-github" /Users/sameshima/test web@ik1-344-32290.vs.sakura.ne.jp:/home/web/temp/
        run: rsync -arptgDvze --delete --exclude-from=.rsyncignore -e ”ssh -i key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no” miniloto-scraping/  ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:/home/web/workspace/test/
      - name: migrate database
        run: ssh -i key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no web@ik1-344-32290.vs.sakura.ne.jp ’cd /home/web/workspace/test && php artisan migrate’
